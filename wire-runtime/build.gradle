import me.champeau.gradle.japicmp.JapicmpTask

apply plugin: 'java-library'
apply plugin: 'org.jetbrains.kotlin.jvm'
apply plugin: 'ru.vyarus.animalsniffer'
apply plugin: 'me.champeau.gradle.japicmp'

sourceCompatibility = JavaVersion.VERSION_1_7
targetCompatibility = JavaVersion.VERSION_1_7

sourceSets {
  test.java.srcDirs += 'src/test/proto-java'
  test.kotlin.srcDirs += 'src/test/proto-kotlin'
}

jar {
  manifest {
    attributes('Automatic-Module-Name': 'wire-runtime')
  }
}

animalsniffer {
  sourceSets = [sourceSets.main]
  ignore 'com.squareup.wire.internal'
}

configurations {
  baseline
}

dependencies {
  api deps.okio
  api deps.kotlin.stdlib.jdk6
  compileOnly deps.android
  compileOnly deps.jsr305
  testImplementation deps.junit
  testImplementation deps.assertj

  baseline('com.squareup.wire:wire-runtime:3.0.0-alpha01') {
    transitive = false
    force = true
  }
}

task japicmp(type: JapicmpTask, dependsOn: 'jar') {
  oldClasspath = configurations.baseline
  newClasspath = files(jar.archivePath)
  onlyBinaryIncompatibleModified = true
  failOnModification = true
  txtOutputFile = file("$buildDir/reports/japi.txt")
  ignoreMissingClasses = true
  includeSynthetic = true
  packageExcludes = [
      'com.squareup.wire.internal',
  ]
  methodExcludes = [
      // package protected -> internal    
      'com.squareup.wire.WireField$Label#isOneOf()',
      'com.squareup.wire.WireField$Label#isPacked()',
      'com.squareup.wire.WireField$Label#isRepeated()',
  ]
}
check.dependsOn japicmp
